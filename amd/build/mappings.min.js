define(['jquery','core/ajax','core/templates'],function($,b,c){let d={};var e={acrredibleSelect:'[id*="_accredibleattribute"]',addButton:'[id*="_add_new_line"]',list:'.attribute_mapping'},f={coursefieldmapping:'coursefieldoptions',coursecustomfieldmapping:'coursecustomfieldoptions',userprofilefieldmapping:'userprofilefieldoptions'},g={init:function(a){d=a;g.setSelectValues();g.listenToAddAction();g.listenToDeleteAction();g.listenToSelectChanges()},listenToAddAction:function(){const A=$(e.addButton);A.on('click',g.addNewLine);A.each((_,B)=>g.toggleAddButton($(B).attr('data-section')))},listenToDeleteAction:function(){$(e.list).on('click','.remove-line',g.removeLine)},listenToSelectChanges:function(){$(e.list).on('change',e.acrredibleSelect,()=>g.checkForDuplicates())},getAttributeValuesCount:function(){const C=new Map();$(e.acrredibleSelect).each((_,_b)=>{const _c=$(_b).val();if(!_c)return;let D=C.get(_c)??0;D++;C.set(_c,D)});return C},checkForDuplicates:function(){const _a=g.getAttributeValuesCount();$(e.acrredibleSelect).each((_,_B)=>{const _C=$(_B).attr('id'),_d=_C.split('_accredibleattribute')[0],E=$(`#${_d}_delete_action`);$(_B).removeClass('is-invalid');E.removeClass('pb-xl-4');g.disableSubmit(!1);_a.get($(_B).val())>1&&($(_B).addClass('is-invalid'),E.addClass('pb-xl-4'),g.disableSubmit(!0))})},addNewLine:function(){const _A=$(this).attr('data-section');g.renderMappingLine({index:g.countLines(_A)+1, section:_A, accredibleoptions:d.accredibleoptions, moodleoptions:d[f[_A]]},`#${_A}_content`);setTimeout(()=>g.toggleAddButton(_A),100)},removeLine:function(){const aA=$(this).attr('data-id'),aB=$(this).attr('data-section');$(`#${aB}_mapping_line_${aA}`).remove();g.toggleAddButton(aB);g.checkForDuplicates()},countLines:function(aC){return $(`[id*="${aC}_mapping_line"]`).length},setSelectValues:function(){$('.attribute_mapping select.form-control').each((_,aD)=>{const aE=$(aD);aE.val(aE.attr('data-initial-value'))})},toggleAddButton:function(aF){const aG=$(`#${aF}_add_new_line`),aH=g.countLines(aF),_D=d[f[aF]].length-1;aH==_D?aG.addClass('hidden'):aG.removeClass('hidden')},disableSubmit:function(aI){$('input:submit[id*="id_submitbutton"]').each((_,aJ)=>$(aJ).attr('disabled',aI))},renderMappingLine:function(aK,aL){c.renderForPromise('mod_accredible/mapping_line',aK).then(aM=>c.appendNodeContents(aL,aM.html,aM.js))}};return g});
